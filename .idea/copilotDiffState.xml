<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/apps/api/app/app.go">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/api/app/app.go" />
              <option name="originalContent" value="package app&#10;&#10;import (&#10;&#9;&quot;techmind/internal/connetions/elasticsearch&quot;&#10;&#9;&quot;techmind/internal/connetions/minio&quot;&#10;&#9;&quot;techmind/internal/connetions/postgres&quot;&#10;&#9;&quot;techmind/internal/di&quot;&#10;&#10;&#9;&quot;go.uber.org/fx&quot;&#10;)&#10;&#10;var App = fx.Options(&#10;&#9;fx.Provide(&#10;&#9;&#9;postgres.New,&#10;&#9;&#9;minio.New,&#10;&#9;&#9;elasticsearch.New,&#10;&#9;),&#10;&#9;di.Repository,&#10;&#9;di.Service,&#10;&#9;di.Transport,&#10;)&#10;" />
              <option name="updatedContent" value="package app&#10;&#10;import (&#10;&#9;&quot;techmind/internal/connetions/elasticsearch&quot;&#10;&#9;&quot;techmind/internal/connetions/minio&quot;&#10;&#9;&quot;techmind/internal/connetions/postgres&quot;&#10;&#9;&quot;techmind/internal/di&quot;&#10;&#10;&#9;&quot;go.uber.org/fx&quot;&#10;)&#10;&#10;var App = fx.Options(&#10;&#9;fx.Provide(&#10;&#9;&#9;postgres.New,&#10;&#9;&#9;minio.New,&#10;&#9;&#9;elasticsearch.New,&#10;&#9;),&#10;&#9;di.Repository,&#10;&#9;di.Service,&#10;&#9;di.Transport,&#10;)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/apps/api/internal/service/company_user_service.go">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/api/internal/service/company_user_service.go" />
              <option name="originalContent" value="&#10;" />
              <option name="updatedContent" value="package service&#10;&#10;import (&#10;&#9;&quot;context&quot;&#10;&#9;&quot;techmind/internal/repo&quot;&#10;&#10;&#9;&quot;github.com/google/uuid&quot;&#10;)&#10;&#10;type companyUserService struct {&#10;&#9;repo repo.CompanyUserRepository&#10;}&#10;&#10;func NewCompanyUserService(repo repo.CompanyUserRepository) CompanyUserService {&#10;&#9;return &amp;companyUserService{repo: repo}&#10;}&#10;&#10;func (s *companyUserService) GetUserRole(ctx context.Context, userID, companyID uuid.UUID) (int, error) {&#10;&#9;return s.repo.GetUserRole(ctx, userID, companyID)&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/apps/api/schema/company.go">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/api/schema/company.go" />
              <option name="originalContent" value="package schema&#10;&#10;import (&#10;&#9;&quot;entgo.io/ent&quot;&#10;&#9;&quot;entgo.io/ent/schema/edge&quot;&#10;&#9;&quot;entgo.io/ent/schema/field&quot;&#10;&#9;&quot;github.com/google/uuid&quot;&#10;)&#10;&#10;// Company holds the schema definition for the Company entity.&#10;type Company struct {&#10;&#9;ent.Schema&#10;}&#10;&#10;// Fields of the Company.&#10;func (Company) Fields() []ent.Field {&#10;&#9;return []ent.Field{&#10;&#9;&#9;field.UUID(&quot;id&quot;, uuid.UUID{}).&#10;&#9;&#9;&#9;Default(uuid.New).&#10;&#9;&#9;&#9;Immutable(),&#10;&#9;&#9;field.String(&quot;name&quot;).&#10;&#9;&#9;&#9;NotEmpty(),&#10;&#9;}&#10;}&#10;&#10;// Edges of the Company.&#10;func (Company) Edges() []ent.Edge {&#10;&#9;return []ent.Edge{&#10;&#9;&#9;edge.To(&quot;company_users&quot;, CompanyUser.Type),&#10;&#9;&#9;edge.To(&quot;folders&quot;, Folder.Type),&#10;&#9;&#9;edge.To(&quot;documents&quot;, Document.Type),&#10;&#9;&#9;edge.To(&quot;tags&quot;, Tag.Type),&#10;&#9;}&#10;}&#10;" />
              <option name="updatedContent" value="package schema&#10;&#10;import (&#10;&#9;&quot;entgo.io/ent&quot;&#10;&#9;&quot;entgo.io/ent/schema/edge&quot;&#10;&#9;&quot;entgo.io/ent/schema/field&quot;&#10;&#9;&quot;github.com/google/uuid&quot;&#10;)&#10;&#10;// Company holds the schema definition for the Company entity.&#10;type Company struct {&#10;&#9;ent.Schema&#10;}&#10;&#10;// Fields of the Company.&#10;func (Company) Fields() []ent.Field {&#10;&#9;return []ent.Field{&#10;&#9;&#9;field.UUID(&quot;id&quot;, uuid.UUID{}).&#10;&#9;&#9;&#9;Default(uuid.New).&#10;&#9;&#9;&#9;Immutable(),&#10;&#9;&#9;field.String(&quot;name&quot;).&#10;&#9;&#9;&#9;NotEmpty(),&#10;&#9;}&#10;}&#10;&#10;// Edges of the Company.&#10;func (Company) Edges() []ent.Edge {&#10;&#9;return []ent.Edge{&#10;&#9;&#9;edge.To(&quot;company_users&quot;, CompanyUser.Type),&#10;&#9;&#9;edge.To(&quot;folders&quot;, Folder.Type),&#10;&#9;&#9;edge.To(&quot;documents&quot;, Document.Type),&#10;&#9;&#9;edge.To(&quot;tags&quot;, Tag.Type),&#10;&#9;}&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/apps/api/schema/document_tag.go">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/api/schema/document_tag.go" />
              <option name="originalContent" value="package schema&#10;&#10;import (&#10;&#9;&quot;entgo.io/ent&quot;&#10;&#9;&quot;entgo.io/ent/schema/edge&quot;&#10;&#9;&quot;entgo.io/ent/schema/field&quot;&#10;&#9;&quot;github.com/google/uuid&quot;&#10;)&#10;&#10;// DocumentTag holds the schema definition for the DocumentTag entity.&#10;type DocumentTag struct {&#10;&#9;ent.Schema&#10;}&#10;&#10;// Fields of the DocumentTag.&#10;func (DocumentTag) Fields() []ent.Field {&#10;&#9;return []ent.Field{&#10;&#9;&#9;field.UUID(&quot;id&quot;, uuid.UUID{}).&#10;&#9;&#9;&#9;Default(uuid.New).&#10;&#9;&#9;&#9;Immutable(),&#10;&#9;&#9;field.UUID(&quot;document_id&quot;, uuid.UUID{}),&#10;&#9;&#9;field.UUID(&quot;tag_id&quot;, uuid.UUID{}),&#10;&#9;}&#10;}&#10;&#10;// Edges of the DocumentTag.&#10;func (DocumentTag) Edges() []ent.Edge {&#10;&#9;return []ent.Edge{&#10;&#9;&#9;edge.From(&quot;document&quot;, Document.Type).&#10;&#9;&#9;&#9;Ref(&quot;document_tags&quot;),&#10;&#9;&#9;edge.From(&quot;tag&quot;, Tag.Type).&#10;&#9;&#9;&#9;Ref(&quot;document_tags&quot;),&#10;&#9;}&#10;}&#10;" />
              <option name="updatedContent" value="package schema&#10;&#10;import (&#10;&#9;&quot;entgo.io/ent&quot;&#10;&#9;&quot;entgo.io/ent/schema/edge&quot;&#10;&#9;&quot;entgo.io/ent/schema/field&quot;&#10;&#9;&quot;github.com/google/uuid&quot;&#10;)&#10;&#10;// DocumentTag holds the schema definition for the DocumentTag entity.&#10;type DocumentTag struct {&#10;&#9;ent.Schema&#10;}&#10;&#10;// Fields of the DocumentTag.&#10;func (DocumentTag) Fields() []ent.Field {&#10;&#9;return []ent.Field{&#10;&#9;&#9;field.UUID(&quot;id&quot;, uuid.UUID{}).&#10;&#9;&#9;&#9;Default(uuid.New).&#10;&#9;&#9;&#9;Immutable(),&#10;&#9;&#9;field.UUID(&quot;document_id&quot;, uuid.UUID{}),&#10;&#9;&#9;field.UUID(&quot;tag_id&quot;, uuid.UUID{}),&#10;&#9;}&#10;}&#10;&#10;// Edges of the DocumentTag.&#10;func (DocumentTag) Edges() []ent.Edge {&#10;&#9;return []ent.Edge{&#10;&#9;&#9;edge.From(&quot;document&quot;, Document.Type).&#10;&#9;&#9;&#9;Ref(&quot;document_tags&quot;),&#10;&#9;&#9;edge.From(&quot;tag&quot;, Tag.Type).&#10;&#9;&#9;&#9;Ref(&quot;document_tags&quot;),&#10;&#9;}&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/apps/api/schema/homework_code_test.go">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/api/schema/homework_code_test.go" />
              <option name="updatedContent" value="package schema&#10;&#10;import (&#10;&#9;&quot;entgo.io/ent&quot;&#10;&#9;&quot;entgo.io/ent/schema/edge&quot;&#10;&#9;&quot;entgo.io/ent/schema/field&quot;&#10;&#9;&quot;github.com/google/uuid&quot;&#10;)&#10;&#10;// HomeworkCodeTest holds the schema definition for the HomeworkCodeTest entity.&#10;type HomeworkCodeTest struct {&#10;&#9;ent.Schema&#10;}&#10;&#10;// Fields of the HomeworkCodeTest.&#10;func (HomeworkCodeTest) Fields() []ent.Field {&#10;&#9;return []ent.Field{&#10;&#9;&#9;field.UUID(&quot;id&quot;, uuid.UUID{}).&#10;&#9;&#9;&#9;Default(uuid.New).&#10;&#9;&#9;&#9;Immutable(),&#10;&#9;&#9;field.UUID(&quot;task_id&quot;, uuid.UUID{}),&#10;&#9;&#9;field.String(&quot;in&quot;),&#10;&#9;&#9;field.String(&quot;out&quot;),&#10;&#9;&#9;field.Bool(&quot;is_hide&quot;).&#10;&#9;&#9;&#9;Default(false),&#10;&#9;}&#10;}&#10;&#10;// Edges of the HomeworkCodeTest.&#10;func (HomeworkCodeTest) Edges() []ent.Edge {&#10;&#9;return []ent.Edge{&#10;&#9;&#9;edge.From(&quot;task&quot;, HomeworkTask.Type).&#10;&#9;&#9;&#9;Ref(&quot;code_tests_rel&quot;).&#10;&#9;&#9;&#9;Field(&quot;task_id&quot;).&#10;&#9;&#9;&#9;Unique().&#10;&#9;&#9;&#9;Required(),&#10;&#9;}&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/apps/api/schema/tag.go">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/api/schema/tag.go" />
              <option name="originalContent" value="package schema&#10;&#10;import (&#10;&#9;&quot;entgo.io/ent&quot;&#10;&#9;&quot;entgo.io/ent/schema/edge&quot;&#10;&#9;&quot;entgo.io/ent/schema/field&quot;&#10;&#9;&quot;github.com/google/uuid&quot;&#10;)&#10;&#10;// Tag holds the schema definition for the Tag entity.&#10;type Tag struct {&#10;&#9;ent.Schema&#10;}&#10;&#10;// Fields of the Tag.&#10;func (Tag) Fields() []ent.Field {&#10;&#9;return []ent.Field{&#10;&#9;&#9;field.UUID(&quot;id&quot;, uuid.UUID{}).&#10;&#9;&#9;&#9;Default(uuid.New).&#10;&#9;&#9;&#9;Immutable(),&#10;&#9;&#9;field.UUID(&quot;company_id&quot;, uuid.UUID{}),&#10;&#9;&#9;field.String(&quot;name&quot;).&#10;&#9;&#9;&#9;NotEmpty(),&#10;&#9;}&#10;}&#10;&#10;// Edges of the Tag.&#10;func (Tag) Edges() []ent.Edge {&#10;&#9;return []ent.Edge{&#10;&#9;&#9;edge.From(&quot;company&quot;, Company.Type).&#10;&#9;&#9;&#9;Ref(&quot;tags&quot;).&#10;&#9;&#9;&#9;Field(&quot;company_id&quot;).&#10;&#9;&#9;&#9;Required().&#10;&#9;&#9;&#9;Unique(),&#10;&#9;&#9;edge.To(&quot;document_tags&quot;, DocumentTag.Type),&#10;&#9;}&#10;}&#10;" />
              <option name="updatedContent" value="package schema&#10;&#10;import (&#10;&#9;&quot;entgo.io/ent&quot;&#10;&#9;&quot;entgo.io/ent/schema/edge&quot;&#10;&#9;&quot;entgo.io/ent/schema/field&quot;&#10;&#9;&quot;github.com/google/uuid&quot;&#10;)&#10;&#10;// Tag holds the schema definition for the Tag entity.&#10;type Tag struct {&#10;&#9;ent.Schema&#10;}&#10;&#10;// Fields of the Tag.&#10;func (Tag) Fields() []ent.Field {&#10;&#9;return []ent.Field{&#10;&#9;&#9;field.UUID(&quot;id&quot;, uuid.UUID{}).&#10;&#9;&#9;&#9;Default(uuid.New).&#10;&#9;&#9;&#9;Immutable(),&#10;&#9;&#9;field.UUID(&quot;company_id&quot;, uuid.UUID{}),&#10;&#9;&#9;field.String(&quot;name&quot;).&#10;&#9;&#9;&#9;NotEmpty(),&#10;&#9;}&#10;}&#10;&#10;// Edges of the Tag.&#10;func (Tag) Edges() []ent.Edge {&#10;&#9;return []ent.Edge{&#10;&#9;&#9;edge.From(&quot;company&quot;, Company.Type).&#10;&#9;&#9;&#9;Ref(&quot;tags&quot;).&#10;&#9;&#9;&#9;Field(&quot;company_id&quot;).&#10;&#9;&#9;&#9;Required().&#10;&#9;&#9;&#9;Unique(),&#10;&#9;&#9;edge.To(&quot;document_tags&quot;, DocumentTag.Type),&#10;&#9;}&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/apps/frontend/Dockerfile">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/frontend/Dockerfile" />
              <option name="originalContent" value="# Dockerfile for Next.js frontend&#10;FROM node:22.21.1-alpine AS base&#10;&#10;# Ensure pnpm is available in all stages by enabling corepack and preparing pnpm&#10;RUN corepack enable &amp;&amp; corepack prepare pnpm@latest --activate&#10;&#10;# Install dependencies only when needed&#10;FROM base AS deps&#10;RUN apk add --no-cache libc6-compat&#10;WORKDIR /app&#10;&#10;COPY package.json package-lock.json* ./&#10;RUN pnpm install&#10;&#10;# Rebuild the source code only when needed&#10;FROM base AS builder&#10;WORKDIR /app&#10;COPY --from=deps /app/node_modules ./node_modules&#10;COPY . .&#10;&#10;ENV NEXT_TELEMETRY_DISABLED 1&#10;&#10;RUN pnpm run build&#10;&#10;# Production image, copy all the files and run next&#10;FROM base AS runner&#10;WORKDIR /app&#10;&#10;ENV NODE_ENV production&#10;ENV NEXT_TELEMETRY_DISABLED 1&#10;&#10;RUN addgroup --system --gid 1001 nodejs&#10;RUN adduser --system --uid 1001 nextjs&#10;&#10;COPY --from=builder /app/public ./public&#10;&#10;# Set the correct permission for prerender cache&#10;RUN mkdir .next&#10;RUN chown nextjs:nodejs .next&#10;&#10;# Automatically leverage output traces to reduce image size&#10;COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./&#10;COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static&#10;&#10;USER nextjs&#10;&#10;EXPOSE 3000&#10;&#10;ENV PORT 3000&#10;ENV HOSTNAME &quot;0.0.0.0&quot;&#10;&#10;CMD [&quot;node&quot;, &quot;server.js&quot;]&#10;&#10;" />
              <option name="updatedContent" value="# Dockerfile for Next.js frontend&#10;FROM node:22.21.1-alpine AS base&#10;&#10;# Ensure pnpm is available in all stages by enabling corepack and preparing pnpm&#10;RUN corepack enable &amp;&amp; corepack prepare pnpm@latest --activate&#10;&#10;# Install dependencies only when needed&#10;FROM base AS deps&#10;RUN apk add --no-cache libc6-compat&#10;WORKDIR /app&#10;&#10;COPY package.json package-lock.json* ./&#10;RUN pnpm install&#10;&#10;# Rebuild the source code only when needed&#10;FROM base AS builder&#10;WORKDIR /app&#10;COPY --from=deps /app/node_modules ./node_modules&#10;COPY . .&#10;&#10;ENV NEXT_TELEMETRY_DISABLED 1&#10;&#10;RUN pnpm run build&#10;&#10;# Production image, copy all the files and run next&#10;FROM base AS runner&#10;WORKDIR /app&#10;&#10;ENV NODE_ENV production&#10;ENV NEXT_TELEMETRY_DISABLED 1&#10;&#10;RUN addgroup --system --gid 1001 nodejs&#10;RUN adduser --system --uid 1001 nextjs&#10;&#10;COPY --from=builder /app/public ./public&#10;&#10;# Set the correct permission for prerender cache&#10;RUN mkdir .next&#10;RUN chown nextjs:nodejs .next&#10;&#10;# Automatically leverage output traces to reduce image size&#10;COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./&#10;COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static&#10;&#10;USER nextjs&#10;&#10;EXPOSE 3000&#10;&#10;ENV PORT 3000&#10;ENV HOSTNAME &quot;0.0.0.0&quot;&#10;&#10;CMD [&quot;node&quot;, &quot;server.js&quot;]" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/apps/frontend/app/files/page.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/frontend/app/files/page.tsx" />
              <option name="originalContent" value="'use client';&#10;&#10;import { useState, useEffect } from 'react';&#10;import { useAuth } from '@/contexts/AuthContext';&#10;import { useRouter } from 'next/navigation';&#10;import { Sidebar } from '@/components/files/Sidebar';&#10;import { FolderTree } from '@/components/files/FolderTree';&#10;import { FilePreview } from '@/components/files/FilePreview';&#10;import { FileInfo } from '@/components/files/FileInfo';&#10;import { foldersApi } from '@/lib/api/folders';&#10;import { documentsApi } from '@/lib/api/documents';&#10;import { Document, Folder } from '@/lib/api/types';&#10;import { Spinner } from '@heroui/spinner';&#10;import { Dropzone } from '@/components/files/Dropzone';&#10;&#10;export default function FilesPage() {&#10;    const { user, currentCompany, isLoading: authLoading } = useAuth();&#10;    const router = useRouter();&#10;    const [folders, setFolders] = useState&lt;Folder[]&gt;([]);&#10;    const [selectedDocument, setSelectedDocument] = useState&lt;Document | null&gt;(null);&#10;    const [selectedFolderId, setSelectedFolderId] = useState&lt;string | null&gt;(null);&#10;    const [folderDocuments, setFolderDocuments] = useState&lt;Document[]&gt;([]);&#10;    const [isLoading, setIsLoading] = useState(true);&#10;    const [treeWidth, setTreeWidth] = useState(300);&#10;    const [previewWidth, setPreviewWidth] = useState(600);&#10;&#10;    useEffect(() =&gt; {&#10;        if (!authLoading &amp;&amp; !user) {&#10;            router.push('/login');&#10;        }&#10;    }, [user, authLoading, router]);&#10;&#10;    useEffect(() =&gt; {&#10;        if (currentCompany) {&#10;            loadFolderTree();&#10;        }&#10;    }, [currentCompany]);&#10;&#10;    // Автоматически выбираем корень при первой загрузке&#10;    useEffect(() =&gt; {&#10;        if (currentCompany &amp;&amp; selectedFolderId === null) {&#10;            handleFolderSelect(null);&#10;        }&#10;        // eslint-disable-next-line react-hooks/exhaustive-deps&#10;    }, [currentCompany]);&#10;&#10;    const loadFolderTree = async () =&gt; {&#10;        if (!currentCompany) return;&#10;        setIsLoading(true);&#10;        try {&#10;            const data = await foldersApi.getAllCompanyFolders(currentCompany.id);&#10;            setFolders(data.folders || []);&#10;        } catch (error) {&#10;            console.error('Failed to load folders:', error);&#10;        } finally {&#10;            setIsLoading(false);&#10;        }&#10;    };&#10;&#10;    // Лениво подгружать документы только для выбранной папки&#10;    const handleFolderSelect = async (folderId: string | null) =&gt; {&#10;        setSelectedFolderId(folderId);&#10;        setSelectedDocument(null);&#10;        setIsLoading(true);&#10;        try {&#10;            if (folderId === null) {&#10;                // Корень: получить все документы компании и отфильтровать по folder_id == null/undefined/''&#10;                if (!currentCompany) throw new Error('Компания не выбрана');&#10;                const data = await documentsApi.getByCompany(currentCompany.id);&#10;                setFolderDocuments((data.documents || []).filter(doc =&gt; doc.folder_id === null || doc.folder_id === undefined || doc.folder_id === ''));&#10;            } else {&#10;                const data = await documentsApi.getByFolder(folderId);&#10;                setFolderDocuments(data.documents || []);&#10;            }&#10;        } catch (error) {&#10;            setFolderDocuments([]);&#10;            console.error('Failed to load documents for folder:', error);&#10;        } finally {&#10;            setIsLoading(false);&#10;        }&#10;    };&#10;&#10;    const handleDocumentSelect = async (doc: Document) =&gt; {&#10;        setSelectedDocument(doc);&#10;        try {&#10;            const fullDoc = await documentsApi.getById(doc.id);&#10;            setSelectedDocument(fullDoc);&#10;        } catch (error) {&#10;            console.error('Failed to load document:', error);&#10;        }&#10;    };&#10;&#10;    const handleFilesUpload = async (files: FileList) =&gt; {&#10;        if (!currentCompany) return;&#10;        try {&#10;            for (const file of Array.from(files)) {&#10;                await documentsApi.upload({&#10;                    company_id: currentCompany.id,&#10;                    name: file.name,&#10;                    file,&#10;                    folder_id: selectedFolderId || undefined,&#10;                });&#10;            }&#10;            // После загрузки обновить содержимое текущей папки&#10;            if (selectedFolderId) {&#10;                handleFolderSelect(selectedFolderId);&#10;            }&#10;        } catch (e) {&#10;            alert('Ошибка загрузки файлов');&#10;        }&#10;    };&#10;&#10;    if (authLoading || !user || !currentCompany) {&#10;        return (&#10;            &lt;div className=&quot;flex items-center justify-center h-screen&quot;&gt;&#10;                &lt;Spinner size=&quot;lg&quot; /&gt;&#10;            &lt;/div&gt;&#10;        );&#10;    }&#10;&#10;    return (&#10;        &lt;div className=&quot;flex flex-col h-screen bg-background&quot;&gt;&#10;            &lt;div className=&quot;p-4&quot;&gt;&#10;                &lt;Dropzone onFilesAdded={handleFilesUpload} /&gt;&#10;            &lt;/div&gt;&#10;            &lt;div className=&quot;flex flex-1 min-h-0&quot;&gt;&#10;                {/* Left Sidebar - Commands */}&#10;                &lt;Sidebar currentView=&quot;files&quot; /&gt;&#10;                {/* Folder Tree */}&#10;                &lt;div&#10;                    className=&quot;border-r border-divider overflow-y-auto&quot;&#10;                    style={{ width: `${treeWidth}px` }}&#10;                &gt;&#10;                    &lt;FolderTree&#10;                        folders={folders}&#10;                        onFolderSelect={handleFolderSelect}&#10;                        selectedFolderId={selectedFolderId}&#10;                        isLoading={isLoading}&#10;                        showRoot&#10;                    /&gt;&#10;                    &lt;div&#10;                        className=&quot;absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-primary&quot;&#10;                        onMouseDown={(e) =&gt; {&#10;                            const startX = e.clientX;&#10;                            const startWidth = treeWidth;&#10;                            const handleMouseMove = (e: MouseEvent) =&gt; {&#10;                                const newWidth = startWidth + (e.clientX - startX);&#10;                                setTreeWidth(Math.max(200, Math.min(600, newWidth)));&#10;                            };&#10;                            const handleMouseUp = () =&gt; {&#10;                                document.removeEventListener('mousemove', handleMouseMove);&#10;                                document.removeEventListener('mouseup', handleMouseUp);&#10;                            };&#10;                            document.addEventListener('mousemove', handleMouseMove);&#10;                            document.addEventListener('mouseup', handleMouseUp);&#10;                        }}&#10;                    /&gt;&#10;                &lt;/div&gt;&#10;                {/* File Preview + список файлов выбранной папки */}&#10;                &lt;div&#10;                    className=&quot;flex-1 border-r border-divider overflow-y-auto&quot;&#10;                    style={{ width: `${previewWidth}px` }}&#10;                &gt;&#10;                    {/* Список файлов выбранной папки */}&#10;                    &lt;div className=&quot;p-4&quot;&gt;&#10;                        {selectedFolderId === null &amp;&amp; folderDocuments.length &gt; 0 &amp;&amp; (&#10;                            &lt;ul&gt;&#10;                                {folderDocuments.map(doc =&gt; (&#10;                                    &lt;li key={doc.id} className=&quot;cursor-pointer hover:underline&quot; onClick={() =&gt; handleDocumentSelect(doc)}&gt;&#10;                                        {doc.name}&#10;                                    &lt;/li&gt;&#10;                                ))}&#10;                            &lt;/ul&gt;&#10;                        )}&#10;                        {selectedFolderId === null &amp;&amp; folderDocuments.length === 0 &amp;&amp; !isLoading &amp;&amp; (&#10;                            &lt;div className=&quot;text-gray-400&quot;&gt;В корне нет файлов&lt;/div&gt;&#10;                        )}&#10;                        {selectedFolderId &amp;&amp; folderDocuments.length &gt; 0 &amp;&amp; (&#10;                            &lt;ul&gt;&#10;                                {folderDocuments.map(doc =&gt; (&#10;                                    &lt;li key={doc.id} className=&quot;cursor-pointer hover:underline&quot; onClick={() =&gt; handleDocumentSelect(doc)}&gt;&#10;                                        {doc.name}&#10;                                    &lt;/li&gt;&#10;                                ))}&#10;                            &lt;/ul&gt;&#10;                        )}&#10;                        {selectedFolderId &amp;&amp; folderDocuments.length === 0 &amp;&amp; !isLoading &amp;&amp; (&#10;                            &lt;div className=&quot;text-gray-400&quot;&gt;В папке нет файлов&lt;/div&gt;&#10;                        )}&#10;                    &lt;/div&gt;&#10;                    &lt;FilePreview document={selectedDocument} /&gt;&#10;                    &lt;div&#10;                        className=&quot;absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-primary&quot;&#10;                        onMouseDown={(e) =&gt; {&#10;                            const startX = e.clientX;&#10;                            const startWidth = previewWidth;&#10;                            const handleMouseMove = (e: MouseEvent) =&gt; {&#10;                                const newWidth = startWidth + (e.clientX - startX);&#10;                                setPreviewWidth(Math.max(400, Math.min(1000, newWidth)));&#10;                            };&#10;                            const handleMouseUp = () =&gt; {&#10;                                document.removeEventListener('mousemove', handleMouseMove);&#10;                                document.removeEventListener('mouseup', handleMouseUp);&#10;                            };&#10;                            document.addEventListener('mousemove', handleMouseMove);&#10;                            document.addEventListener('mouseup', handleMouseUp);&#10;                        }}&#10;                    /&gt;&#10;                &lt;/div&gt;&#10;                {/* File Info */}&#10;                &lt;div className=&quot;w-80 overflow-y-auto&quot;&gt;&#10;                    &lt;FileInfo document={selectedDocument} onUpdate={() =&gt; { if (selectedFolderId) handleFolderSelect(selectedFolderId); }} /&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    );&#10;}&#10;" />
              <option name="updatedContent" value="'use client';&#10;&#10;import { useState, useEffect } from 'react';&#10;import { useAuth } from '@/contexts/AuthContext';&#10;import { useRouter } from 'next/navigation';&#10;import { Sidebar } from '@/components/files/Sidebar';&#10;import { FolderTree } from '@/components/files/FolderTree';&#10;import { FilePreview } from '@/components/files/FilePreview';&#10;import { FileInfo } from '@/components/files/FileInfo';&#10;import { foldersApi } from '@/lib/api/folders';&#10;import { documentsApi } from '@/lib/api/documents';&#10;import { Document, Folder } from '@/lib/api/types';&#10;import { Spinner } from '@heroui/spinner';&#10;import { Dropzone } from '@/components/files/Dropzone';&#10;&#10;export default function FilesPage() {&#10;    const { user, currentCompany, isLoading: authLoading } = useAuth();&#10;    const router = useRouter();&#10;    const [folders, setFolders] = useState&lt;Folder[]&gt;([]);&#10;    const [selectedDocument, setSelectedDocument] = useState&lt;Document | null&gt;(null);&#10;    const [selectedFolderId, setSelectedFolderId] = useState&lt;string | null&gt;(null);&#10;    const [folderDocuments, setFolderDocuments] = useState&lt;Document[]&gt;([]);&#10;    const [isLoading, setIsLoading] = useState(true);&#10;    const [treeWidth, setTreeWidth] = useState(300);&#10;    const [previewWidth, setPreviewWidth] = useState(600);&#10;&#10;    useEffect(() =&gt; {&#10;        if (!authLoading &amp;&amp; !user) {&#10;            router.push('/login');&#10;        }&#10;    }, [user, authLoading, router]);&#10;&#10;    useEffect(() =&gt; {&#10;        if (currentCompany) {&#10;            loadFolderTree();&#10;        }&#10;    }, [currentCompany]);&#10;&#10;    // Автоматически выбираем корень при первой загрузке&#10;    useEffect(() =&gt; {&#10;        if (currentCompany &amp;&amp; selectedFolderId === null) {&#10;            handleFolderSelect(null);&#10;        }&#10;        // eslint-disable-next-line react-hooks/exhaustive-deps&#10;    }, [currentCompany]);&#10;&#10;    const loadFolderTree = async () =&gt; {&#10;        if (!currentCompany) return;&#10;        setIsLoading(true);&#10;        try {&#10;            const data = await foldersApi.getAllCompanyFolders(currentCompany.id);&#10;            setFolders(data.folders || []);&#10;        } catch (error) {&#10;            console.error('Failed to load folders:', error);&#10;        } finally {&#10;            setIsLoading(false);&#10;        }&#10;    };&#10;&#10;    // Лениво подгружать документы только для выбранной папки&#10;    const handleFolderSelect = async (folderId: string | null) =&gt; {&#10;        setSelectedFolderId(folderId);&#10;        setSelectedDocument(null);&#10;        setIsLoading(true);&#10;        try {&#10;            if (folderId === null) {&#10;                // Корень: получить все документы компании и отфильтровать по folder_id == null/undefined/''&#10;                if (!currentCompany) throw new Error('Компания не выбрана');&#10;                const data = await documentsApi.getByCompany(currentCompany.id);&#10;                setFolderDocuments((data.documents || []).filter(doc =&gt; doc.folder_id === null || doc.folder_id === undefined || doc.folder_id === ''));&#10;            } else {&#10;                const data = await documentsApi.getByFolder(folderId);&#10;                setFolderDocuments(data.documents || []);&#10;            }&#10;        } catch (error) {&#10;            setFolderDocuments([]);&#10;            console.error('Failed to load documents for folder:', error);&#10;        } finally {&#10;            setIsLoading(false);&#10;        }&#10;    };&#10;&#10;    const handleDocumentSelect = async (doc: Document) =&gt; {&#10;        setSelectedDocument(doc);&#10;        try {&#10;            const fullDoc = await documentsApi.getById(doc.id);&#10;            setSelectedDocument(fullDoc);&#10;        } catch (error) {&#10;            console.error('Failed to load document:', error);&#10;        }&#10;    };&#10;&#10;    const handleDocumentUpdate = async () =&gt; {&#10;        // Перезагружаем текущий документ после изменений (например, добавления/удаления тегов)&#10;        if (selectedDocument) {&#10;            try {&#10;                const updatedDoc = await documentsApi.getById(selectedDocument.id);&#10;                setSelectedDocument(updatedDoc);&#10;            } catch (error) {&#10;                console.error('Failed to reload document:', error);&#10;            }&#10;        }&#10;    };&#10;&#10;    const handleFilesUpload = async (files: FileList) =&gt; {&#10;        if (!currentCompany) return;&#10;        try {&#10;            for (const file of Array.from(files)) {&#10;                await documentsApi.upload({&#10;                    company_id: currentCompany.id,&#10;                    name: file.name,&#10;                    file,&#10;                    folder_id: selectedFolderId || undefined,&#10;                });&#10;            }&#10;            // После загрузки обновить содержимое текущей папки&#10;            if (selectedFolderId) {&#10;                handleFolderSelect(selectedFolderId);&#10;            }&#10;        } catch (e) {&#10;            alert('Ошибка загрузки файлов');&#10;        }&#10;    };&#10;&#10;    if (authLoading || !user || !currentCompany) {&#10;        return (&#10;            &lt;div className=&quot;flex items-center justify-center h-screen&quot;&gt;&#10;                &lt;Spinner size=&quot;lg&quot; /&gt;&#10;            &lt;/div&gt;&#10;        );&#10;    }&#10;&#10;    return (&#10;        &lt;div className=&quot;flex flex-col h-screen bg-background&quot;&gt;&#10;            &lt;div className=&quot;p-4&quot;&gt;&#10;                &lt;Dropzone onFilesAdded={handleFilesUpload} /&gt;&#10;            &lt;/div&gt;&#10;            &lt;div className=&quot;flex flex-1 min-h-0&quot;&gt;&#10;                {/* Left Sidebar - Commands */}&#10;                &lt;Sidebar currentView=&quot;files&quot; /&gt;&#10;                {/* Folder Tree */}&#10;                &lt;div&#10;                    className=&quot;border-r border-divider overflow-y-auto&quot;&#10;                    style={{ width: `${treeWidth}px` }}&#10;                &gt;&#10;                    &lt;FolderTree&#10;                        folders={folders}&#10;                        onFolderSelect={handleFolderSelect}&#10;                        selectedFolderId={selectedFolderId}&#10;                        isLoading={isLoading}&#10;                        showRoot&#10;                    /&gt;&#10;                    &lt;div&#10;                        className=&quot;absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-primary&quot;&#10;                        onMouseDown={(e) =&gt; {&#10;                            const startX = e.clientX;&#10;                            const startWidth = treeWidth;&#10;                            const handleMouseMove = (e: MouseEvent) =&gt; {&#10;                                const newWidth = startWidth + (e.clientX - startX);&#10;                                setTreeWidth(Math.max(200, Math.min(600, newWidth)));&#10;                            };&#10;                            const handleMouseUp = () =&gt; {&#10;                                document.removeEventListener('mousemove', handleMouseMove);&#10;                                document.removeEventListener('mouseup', handleMouseUp);&#10;                            };&#10;                            document.addEventListener('mousemove', handleMouseMove);&#10;                            document.addEventListener('mouseup', handleMouseUp);&#10;                        }}&#10;                    /&gt;&#10;                &lt;/div&gt;&#10;                {/* File Preview + список файлов выбранной папки */}&#10;                &lt;div&#10;                    className=&quot;flex-1 border-r border-divider overflow-y-auto&quot;&#10;                    style={{ width: `${previewWidth}px` }}&#10;                &gt;&#10;                    {/* Список файлов выбранной папки */}&#10;                    &lt;div className=&quot;p-4&quot;&gt;&#10;                        {selectedFolderId === null &amp;&amp; folderDocuments.length &gt; 0 &amp;&amp; (&#10;                            &lt;ul&gt;&#10;                                {folderDocuments.map(doc =&gt; (&#10;                                    &lt;li key={doc.id} className=&quot;cursor-pointer hover:underline&quot; onClick={() =&gt; handleDocumentSelect(doc)}&gt;&#10;                                        {doc.name}&#10;                                    &lt;/li&gt;&#10;                                ))}&#10;                            &lt;/ul&gt;&#10;                        )}&#10;                        {selectedFolderId === null &amp;&amp; folderDocuments.length === 0 &amp;&amp; !isLoading &amp;&amp; (&#10;                            &lt;div className=&quot;text-gray-400&quot;&gt;В корне нет файлов&lt;/div&gt;&#10;                        )}&#10;                        {selectedFolderId &amp;&amp; folderDocuments.length &gt; 0 &amp;&amp; (&#10;                            &lt;ul&gt;&#10;                                {folderDocuments.map(doc =&gt; (&#10;                                    &lt;li key={doc.id} className=&quot;cursor-pointer hover:underline&quot; onClick={() =&gt; handleDocumentSelect(doc)}&gt;&#10;                                        {doc.name}&#10;                                    &lt;/li&gt;&#10;                                ))}&#10;                            &lt;/ul&gt;&#10;                        )}&#10;                        {selectedFolderId &amp;&amp; folderDocuments.length === 0 &amp;&amp; !isLoading &amp;&amp; (&#10;                            &lt;div className=&quot;text-gray-400&quot;&gt;В папке нет файлов&lt;/div&gt;&#10;                        )}&#10;                    &lt;/div&gt;&#10;                    &lt;FilePreview document={selectedDocument} /&gt;&#10;                    &lt;div&#10;                        className=&quot;absolute top-0 right-0 w-1 h-full cursor-col-resize hover:bg-primary&quot;&#10;                        onMouseDown={(e) =&gt; {&#10;                            const startX = e.clientX;&#10;                            const startWidth = previewWidth;&#10;                            const handleMouseMove = (e: MouseEvent) =&gt; {&#10;                                const newWidth = startWidth + (e.clientX - startX);&#10;                                setPreviewWidth(Math.max(400, Math.min(1000, newWidth)));&#10;                            };&#10;                            const handleMouseUp = () =&gt; {&#10;                                document.removeEventListener('mousemove', handleMouseMove);&#10;                                document.removeEventListener('mouseup', handleMouseUp);&#10;                            };&#10;                            document.addEventListener('mousemove', handleMouseMove);&#10;                            document.addEventListener('mouseup', handleMouseUp);&#10;                        }}&#10;                    /&gt;&#10;                &lt;/div&gt;&#10;                {/* File Info */}&#10;                &lt;div className=&quot;w-80 overflow-y-auto&quot;&gt;&#10;                    &lt;FileInfo document={selectedDocument} onUpdate={handleDocumentUpdate} /&gt;&#10;                &lt;/div&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    );&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/apps/frontend/app/search/page.tsx">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/apps/frontend/app/search/page.tsx" />
              <option name="originalContent" value="'use client';&#10;&#10;import { useState, useEffect } from 'react';&#10;import { useAuth } from '@/contexts/AuthContext';&#10;import { useRouter } from 'next/navigation';&#10;import { Sidebar } from '@/components/files/Sidebar';&#10;import { SearchPanel } from '@/components/search/SearchPanel';&#10;import { FilePreview } from '@/components/files/FilePreview';&#10;import { FileInfo } from '@/components/files/FileInfo';&#10;import { documentsApi } from '@/lib/api/documents';&#10;import { Document } from '@/lib/api/types';&#10;import { Spinner } from '@heroui/spinner';&#10;&#10;export default function SearchPage() {&#10;    const { user, currentCompany, isLoading: authLoading } = useAuth();&#10;    const router = useRouter();&#10;    const [searchResults, setSearchResults] = useState&lt;Document[]&gt;([]);&#10;    const [selectedDocument, setSelectedDocument] = useState&lt;Document | null&gt;(null);&#10;    const [isLoading, setIsLoading] = useState(false);&#10;    const [highlightedIds, setHighlightedIds] = useState&lt;string[]&gt;([]);&#10;&#10;    useEffect(() =&gt; {&#10;        if (!authLoading &amp;&amp; !user) {&#10;            router.push('/login');&#10;        }&#10;    }, [user, authLoading, router]);&#10;&#10;    const handleSearch = async (query: string, tagIds: string[], senderId?: string) =&gt; {&#10;        if (!currentCompany) return;&#10;&#10;        console.log('Search params:', { query, tagIds, senderId, company_id: currentCompany.id });&#10;        setIsLoading(true);&#10;        try {&#10;            const { documents } = await documentsApi.search({&#10;                company_id: currentCompany.id,&#10;                query: query || undefined,&#10;                tag_ids: tagIds.length &gt; 0 ? tagIds : undefined,&#10;                sender_id: senderId || undefined,&#10;            });&#10;            console.log('Search results:', documents);&#10;            setSearchResults(documents);&#10;            setHighlightedIds(documents.map(d =&gt; d.id));&#10;        } catch (error) {&#10;            console.error('Search failed:', error);&#10;        } finally {&#10;            setIsLoading(false);&#10;        }&#10;    };&#10;&#10;    const handleDocumentSelect = async (doc: Document) =&gt; {&#10;        setSelectedDocument(doc);&#10;        try {&#10;            const fullDoc = await documentsApi.getById(doc.id);&#10;            setSelectedDocument(fullDoc);&#10;        } catch (error) {&#10;            console.error('Failed to load document:', error);&#10;        }&#10;    };&#10;&#10;    if (authLoading || !user || !currentCompany) {&#10;        return (&#10;            &lt;div className=&quot;flex items-center justify-center h-screen&quot;&gt;&#10;                &lt;Spinner size=&quot;lg&quot; /&gt;&#10;            &lt;/div&gt;&#10;        );&#10;    }&#10;&#10;    return (&#10;        &lt;div className=&quot;flex h-screen bg-background&quot;&gt;&#10;            &lt;Sidebar currentView=&quot;search&quot; /&gt;&#10;&#10;            &lt;div className=&quot;w-80 border-r border-divider overflow-y-auto&quot;&gt;&#10;                &lt;SearchPanel&#10;                    onSearch={handleSearch}&#10;                    results={searchResults}&#10;                    onDocumentSelect={handleDocumentSelect}&#10;                    isLoading={isLoading}&#10;                    highlightedIds={highlightedIds}&#10;                /&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div className=&quot;flex-1 border-r border-divider overflow-y-auto&quot;&gt;&#10;                &lt;FilePreview document={selectedDocument} /&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div className=&quot;w-80 overflow-y-auto&quot;&gt;&#10;                &lt;FileInfo document={selectedDocument} onUpdate={() =&gt; {}} /&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    );&#10;}&#10;&#10;" />
              <option name="updatedContent" value="'use client';&#10;&#10;import { useState, useEffect } from 'react';&#10;import { useAuth } from '@/contexts/AuthContext';&#10;import { useRouter } from 'next/navigation';&#10;import { Sidebar } from '@/components/files/Sidebar';&#10;import { SearchPanel } from '@/components/search/SearchPanel';&#10;import { FilePreview } from '@/components/files/FilePreview';&#10;import { FileInfo } from '@/components/files/FileInfo';&#10;import { documentsApi } from '@/lib/api/documents';&#10;import { Document } from '@/lib/api/types';&#10;import { Spinner } from '@heroui/spinner';&#10;&#10;export default function SearchPage() {&#10;    const { user, currentCompany, isLoading: authLoading } = useAuth();&#10;    const router = useRouter();&#10;    const [searchResults, setSearchResults] = useState&lt;Document[]&gt;([]);&#10;    const [selectedDocument, setSelectedDocument] = useState&lt;Document | null&gt;(null);&#10;    const [isLoading, setIsLoading] = useState(false);&#10;    const [highlightedIds, setHighlightedIds] = useState&lt;string[]&gt;([]);&#10;&#10;    useEffect(() =&gt; {&#10;        if (!authLoading &amp;&amp; !user) {&#10;            router.push('/login');&#10;        }&#10;    }, [user, authLoading, router]);&#10;&#10;    const handleSearch = async (query: string, tagIds: string[], senderId?: string) =&gt; {&#10;        if (!currentCompany) return;&#10;&#10;        console.log('Search params:', { query, tagIds, senderId, company_id: currentCompany.id });&#10;        setIsLoading(true);&#10;        try {&#10;            const { documents } = await documentsApi.search({&#10;                company_id: currentCompany.id,&#10;                query: query || undefined,&#10;                tag_ids: tagIds.length &gt; 0 ? tagIds : undefined,&#10;                sender_id: senderId || undefined,&#10;            });&#10;            console.log('Search results:', documents);&#10;            setSearchResults(documents);&#10;            setHighlightedIds(documents.map(d =&gt; d.id));&#10;        } catch (error) {&#10;            console.error('Search failed:', error);&#10;        } finally {&#10;            setIsLoading(false);&#10;        }&#10;    };&#10;&#10;    const handleDocumentSelect = async (doc: Document) =&gt; {&#10;        setSelectedDocument(doc);&#10;        try {&#10;            const fullDoc = await documentsApi.getById(doc.id);&#10;            setSelectedDocument(fullDoc);&#10;        } catch (error) {&#10;            console.error('Failed to load document:', error);&#10;        }&#10;    };&#10;&#10;    if (authLoading || !user || !currentCompany) {&#10;        return (&#10;            &lt;div className=&quot;flex items-center justify-center h-screen&quot;&gt;&#10;                &lt;Spinner size=&quot;lg&quot; /&gt;&#10;            &lt;/div&gt;&#10;        );&#10;    }&#10;&#10;    return (&#10;        &lt;div className=&quot;flex h-screen bg-background&quot;&gt;&#10;            &lt;Sidebar currentView=&quot;search&quot; /&gt;&#10;&#10;            &lt;div className=&quot;w-80 border-r border-divider overflow-y-auto&quot;&gt;&#10;                &lt;SearchPanel&#10;                    onSearch={handleSearch}&#10;                    results={searchResults}&#10;                    onDocumentSelect={handleDocumentSelect}&#10;                    isLoading={isLoading}&#10;                    highlightedIds={highlightedIds}&#10;                /&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div className=&quot;flex-1 border-r border-divider overflow-y-auto&quot;&gt;&#10;                &lt;FilePreview document={selectedDocument} /&gt;&#10;            &lt;/div&gt;&#10;&#10;            &lt;div className=&quot;w-80 overflow-y-auto&quot;&gt;&#10;                &lt;FileInfo document={selectedDocument} onUpdate={handleDocumentUpdate} /&gt;&#10;            &lt;/div&gt;&#10;        &lt;/div&gt;&#10;    );&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>